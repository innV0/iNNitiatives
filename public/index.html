<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iNNitiatives - Enhanced Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/lucide@latest/dist/iconfont/lucide.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- <script src="https://unpkg.com/lucide@latest"></script> --> <!-- Consolidated UMD main script is used -->
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for sanitizing HTML -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Chart.js for charting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'light': {
                            50: '#fafafa',
                            100: '#f5f5f5',
                            200: '#e5e5e5',
                            300: '#d4d4d4',
                            400: '#a3a3a3',
                            500: '#737373',
                            600: '#525252',
                            700: '#404040',
                            800: '#262626',
                            900: '#171717',
                            950: '#0a0a0a'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            margin-right: 8px;
        }
        .tooltip-icon {
            cursor: help;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px; height: 16px;
            border-radius: 50%;
            background-color: #737373;
            color: white;
            font-size: 10px;
            font-weight: bold;
            font-style: normal;
        }
        .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: #171717;
            color: #fafafa;
            text-align: left;
            font-family: sans-serif;
            font-size: 0.875rem;
            font-weight: normal;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 50;
            top: 50%;
            left: 125%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid #404040;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 50%;
            right: 100%;
            margin-top: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent #171717 transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .form-field {
            margin-bottom: 1.5rem;
        }
        .form-label {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;    /* Tailwind: font-semibold */
            color: #1f2937;      /* Tailwind: text-gray-800 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d4d4d4; /* border-gray-300 */
            border-radius: 8px; /* rounded-lg */
            background-color: #ffffff; /* bg-white */
            color: #171717; /* text-gray-900 / text-neutral-900 */
            font-size: 0.875rem; /* text-sm */
            transition: all 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); /* focus:ring-blue-500 focus:ring-opacity-10 */
        }
        .form-textarea {
            resize: vertical;
            min-height: 5rem;
        }
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d4d4d4;
            border-radius: 8px;
            background-color: #ffffff;
            color: #171717;
            font-size: 0.875rem;
        }
        .card-hover {
            transition: all 0.2s ease-in-out;
            /* cursor: pointer; */
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .priority-high { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .priority-medium { background-color: #fffbeb; color: #d97706; border: 1px solid #fed7aa; }
        .priority-low { background-color: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
        .phase-active { background-color: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        .phase-completed { background-color: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
        .phase-hold { background-color: #fffbeb; color: #d97706; border: 1px solid #fed7aa; }
        .phase-cancelled { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        .form-grid {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 8px;
        }
        .form-grid::-webkit-scrollbar {
            width: 6px;
        }
        .form-grid::-webkit-scrollbar-track {
            background: #f5f5f5;
            border-radius: 3px;
        }
        .form-grid::-webkit-scrollbar-thumb {
            background: #d4d4d4;
            border-radius: 3px;
        }
        .form-grid::-webkit-scrollbar-thumb:hover {
            background: #a3a3a3;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .notification.show {
            transform: translateX(0);
        }
        .initiative-card {
            transition: all 0.2s ease-in-out;
        }
        .array-item-input-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .array-item-input {
            flex-grow: 1;
            margin-right: 0.5rem;
        }
        .sort-icon {
            width: 1em;
            height: 1em;
            margin-left: 0.25rem;
        }
        .kanban-column {
            min-height: 200px; /* Ensure columns have a min height for empty states */
        }
         .hover-actions {
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.2s linear;
        }
        .card-hover:hover .hover-actions {
            visibility: visible;
            opacity: 1;
        }
         .view-item-modal-content {
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
        }
        .view-item-modal-content .field-display {
            margin-bottom: 16px;
        }
        .view-item-modal-content .field-label {
            font-weight: 600;
            color: #4b5563; /* gray-700 */
            font-size: 0.875rem; /* text-sm */
            margin-bottom: 4px;
        }
        .view-item-modal-content .field-value {
            color: #1f2937; /* gray-900 */
            font-size: 1rem; /* text-base */
            white-space: pre-wrap; /* Preserve line breaks */
        }
         .view-item-modal-content .related-items-section {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb; /* gray-200 */
        }
         .view-item-modal-content .related-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }
         .view-item-modal-content .related-item-card {
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }
         .view-item-modal-content .related-item-card:hover {
            background-color: #eff6ff; /* blue-50 */
            border-color: #3b82f6; /* blue-500 */
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
         .view-item-modal-content .related-item-title {
            font-weight: 600;
            color: #1f2937; /* gray-900 */
            font-size: 0.875rem; /* text-sm */
            overflow: hidden; /* Add overflow hidden to make truncate work */
            text-overflow: ellipsis; /* Add ellipsis for truncated text */
            white-space: nowrap; /* Prevent text from wrapping */
        }
         .view-item-modal-content .related-item-type {
            font-size: 0.75rem; /* text-xs */
            color: #6b7280; /* gray-500 */
         }
    </style>
</head>
<body class="bg-white text-gray-900 font-sans min-h-screen">
    <div id="app">
        <!-- Notifications Container -->
        <div id="notifications-container" class="fixed top-4 right-4 z-50 space-y-2">
            <div v-for="notification in notifications" :key="notification.id"
                 :class="['notification', 'bg-white', 'border', 'rounded-lg', 'shadow-lg', 'p-4', 'max-w-sm',
                         notification.type === 'success' ? 'border-green-200' :
                         notification.type === 'error' ? 'border-red-200' : 'border-blue-200',
                         notification.show ? 'show' : '']">
                <div class="flex items-start">
                    <div :class="['flex-shrink-0', 'mr-3']">
                        <i :data-lucide="notification.type === 'success' ? 'check-circle' :
                                        notification.type === 'error' ? 'x-circle' : 'info'"
                           :class="[notification.type === 'success' ? 'text-green-500' :
                                   notification.type === 'error' ? 'text-red-500' : 'text-blue-500']"
                           class="w-5 h-5"></i>
                    </div>
                    <div class="flex-1">
                        <p :class="['text-sm', 'font-medium',
                                   notification.type === 'success' ? 'text-green-800' :
                                   notification.type === 'error' ? 'text-red-800' : 'text-blue-800']">
                            {{ notification.title }}
                        </p>
                        <p :class="['text-sm', 'mt-1',
                                   notification.type === 'success' ? 'text-green-600' :
                                   notification.type === 'error' ? 'text-red-600' : 'text-blue-600']">
                            {{ notification.message }}
                        </p>
                    </div>
                    <button @click="removeNotification(notification.id)"
                            class="flex-shrink-0 ml-2 text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-40 backdrop-blur-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <div @click="activeTab = 'dashboard'" class="flex items-center space-x-3 cursor-pointer group">
                            <img src="https://innv0.com/assets/innv0_logo.svg" alt="iNNitiatives Logo" class="w-8 h-8 group-hover:scale-105 transition-transform">
                            <h1 class="text-xl font-bold text-gray-900">iNNitiatives</h1>
                             <span v-if="appData.program && appData.program.programName" class="text-lg font-medium text-gray-700 ml-4">- {{ appData.program.programName }}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <input type="file" ref="fileInput" @change="loadDataFile" accept=".json" class="hidden">
                        <button @click="$refs.fileInput.click()" class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-gray-300">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            <span>Load Data</span>
                        </button>

                        <button @click="exportData" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            <span>Export</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white border-b border-gray-200 sticky top-16 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-1 overflow-x-auto">
                    <button v-for="tab in tabs" :key="tab.id"
                            @click="activeTab = tab.id"
                            :class="[
                                'flex items-center space-x-2 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors whitespace-nowrap',
                                activeTab === tab.id
                                    ? 'bg-gray-50 text-blue-600 border-b-2 border-blue-600'
                                    : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'
                            ]">
                        <i :data-lucide="tab.icon" class="w-4 h-4"></i>
                        <span>{{ tab.name }}</span>
                    </button>
                    <a href="https://docsify-this.net/?basePath=https://innv0.github.io/iNNitiatives/public&homepage=docs.md&sidebar=true#/" target="_blank" class="flex items-center space-x-2 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors whitespace-nowrap text-gray-600 hover:text-gray-900 hover:bg-gray-50">
                        <i data-lucide="book" class="w-4 h-4"></i>
                        <span>Docs</span>
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Tab -->
            <section v-if="activeTab === 'dashboard'" class="space-y-8">
                <div v-if="isEmptyData" class="text-center py-16">
                    <div class="bg-gray-50 rounded-2xl p-12 border border-gray-200">
                        <img src="https://innv0.com/assets/innv0_logo.svg" alt="iNNitiatives Logo" class="w-12 h-12 ">
                        <h2 class="text-3xl font-bold text-gray-900 mb-4">Welcome to iNNitiatives!</h2>
                        <p class="text-gray-600 text-lg mb-8 max-w-2xl mx-auto">Transform your innovation management with our comprehensive platform. Track ideas, manage teams, and drive breakthrough initiatives.</p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button @click="$refs.fileInput.click()" class="flex items-center justify-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                                <i data-lucide="upload" class="w-5 h-5"></i>
                                <span>Load Your Data</span>
                            </button>
                            <button @click="loadSampleData" class="flex items-center justify-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg border border-gray-300 transition-colors">
                                <i data-lucide="play" class="w-5 h-5"></i>
                                <span>Try Sample Data</span>
                            </button>
                        </div>
                        <p class="text-gray-500 text-sm mt-6">Upload a JSON file conforming to the iNNitiatives schema</p>
                    </div>
                </div>
                <div v-else class="space-y-8">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div @click="activeTab = 'people'" class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm card-hover cursor-pointer">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Team Members</p>
                                    <p class="text-2xl font-bold text-gray-900 mt-1">{{ appData.people.length }}</p>
                                </div>
                                <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center">
                                    <i data-lucide="users" class="w-6 h-6 text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        <div @click="activeTab = 'opportunities'" class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm card-hover cursor-pointer">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Opportunities</p>
                                    <p class="text-2xl font-bold text-gray-900 mt-1">{{ appData.opportunities.length }}</p>
                                </div>
                                <div class="w-12 h-12 bg-yellow-50 rounded-lg flex items-center justify-center">
                                    <i data-lucide="lightbulb" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                            </div>
                        </div>
                        <div @click="activeTab = 'initiatives'" class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm card-hover cursor-pointer">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Active Initiatives</p>
                                    <p class="text-2xl font-bold text-gray-900 mt-1">{{ appData.initiatives.length }}</p>
                                </div>
                                <div class="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center">
                                    <i data-lucide="zap" class="w-6 h-6 text-purple-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Kanban Board Section -->
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <i data-lucide="columns" class="w-5 h-5 mr-2 text-indigo-600"></i>
                            Initiative Progress (Kanban)
                        </h3>
                        <div class="flex space-x-4 overflow-x-auto pb-4">
                            <div v-for="phase in kanbanPhases" :key="phase"
                                 class="bg-gray-100 rounded-lg p-4 w-80 md:w-96 flex-shrink-0 kanban-column">
                                <h4 class="font-semibold text-gray-700 mb-3 text-center">{{ phase }} ({{ (initiativesByPhase[phase] || []).length }})</h4>
                                <div class="space-y-3">
                                    <div v-if="(initiativesByPhase[phase] || []).length === 0" class="text-center text-gray-500 text-sm pt-4">
                                        No initiatives in this phase.
                                    </div>
                                    <div v-for="init in (initiativesByPhase[phase] || [])" :key="init.initiativeId"
                                         class="bg-white p-3 rounded-md shadow-sm hover:shadow-lg cursor-pointer border border-gray-200 hover:border-blue-500 transition-all">
                                        <p class="text-base font-medium text-blue-700 truncate mb-1" :title="init.initiativeName">{{ init.initiativeName }}</p>
                                        <p v-if="init.initiativeManagerId" class="text-xs text-gray-600 truncate">
                                            <i data-lucide="user-circle" class="w-3 h-3 inline-block mr-1 text-gray-400"></i>{{ getPersonName(init.initiativeManagerId) }}
                                        </p>
                                        <div class="mt-2 pt-2 border-t border-gray-100 flex justify-between items-center">
                                            <span class="text-xs text-gray-500">{{init.initiativeType}}</span>
                                            <span :class="appUtils.getPhaseClass(init.initiativePhase)" class="status-badge text-xs">
                                                {{ init.initiativePhase }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Overview Sections (Existing) -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i data-lucide="pie-chart" class="w-5 h-5 mr-2 text-blue-600"></i>
                                Initiatives by Phase Summary
                            </h3>
                            <div class="space-y-3">
                                <div v-for="phase in initiativePhases" :key="phase.name" class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div :class="['w-3 h-3 rounded-full', appUtils.getPhaseColor(phase.name)]"></div>
                                        <span class="text-sm text-gray-700">{{ phase.name }}</span>
                                    </div>
                                    <span class="text-sm font-medium text-gray-900">{{ phase.count }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i data-lucide="trending-up" class="w-5 h-5 mr-2 text-yellow-600"></i>
                                Top Priority Opportunities
                            </h3>
                            <div class="space-y-3">
                                <div v-for="opp in topOpportunities" :key="opp.opportunityId" class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-900 truncate">{{ opp.opportunityName }}</p>
                                        <p class="text-xs text-gray-600">{{ getPersonName(opp.opportunityProposerId) }}</p>
                                    </div>
                                    <span :class="appUtils.getPriorityClass(opp.opportunityPriority)" class="status-badge">
                                        {{ opp.opportunityPriority }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i data-lucide="users" class="w-5 h-5 mr-2 text-green-600"></i>
                            Team Overview
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="person in appData.people.slice(0, 6)" :key="person.personId" class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                <img :src="getPersonAvatar(person.personId)"
                                     :alt="person.personName"
                                     class="w-10 h-10 rounded-full object-cover border-2 border-gray-200">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">{{ person.personName }}</p>
                                    <p class="text-xs text-gray-600">{{ getPersonInitiativeCount(person.personId) }} initiatives</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i data-lucide="activity" class="w-5 h-5 mr-2 text-blue-600"></i>
                            Recent Activity
                        </h3>
                        <div class="space-y-3">
                            <div v-for="initiative in recentInitiatives" :key="initiative.initiativeId" class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-2 h-2 bg-blue-600 rounded-full"></div>
                                <div class="flex-1">
                                    <p class="text-gray-900 font-medium">{{ initiative.initiativeName }}</p>
                                    <p class="text-gray-600 text-sm">Updated {{ appUtils.formatDate(initiative.initiativeLastUpdated) }}</p>
                                </div>
                                <span :class="appUtils.getPhaseClass(initiative.initiativePhase)" class="status-badge">
                                    {{ initiative.initiativePhase }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Program Tab -->
            <section v-if="activeTab === 'program'" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Program Configuration</h2>
                        <p class="text-gray-600 mt-1">Manage your innovation program settings and objectives</p>
                    </div>
                    <button @click="editProgram" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                        <span>Edit Program</span>
                    </button>
                    <button @click="openAiModal('program', appData.program)" title="AI Assistant for Program" class="flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i data-lucide="bot" class="w-4 h-4"></i>
                        <span>AI</span>
                    </button>
                </div>

                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <div v-if="appData.program" class="grid grid-cols-1 gap-6">
                        <div v-for="(value, key) in appData.program" :key="key" class="space-y-2 p-4 bg-gray-50 rounded-lg border">
                            <dt class="text-sm font-medium text-gray-600 flex items-center">
                                <span class="tooltip-container">
                                    <i class="tooltip-icon">?</i>
                                    <span class="tooltip-text">{{ getFieldDescription('program.' + key) }}</span>
                                </span>
                                {{ appUtils.formatFieldName(key) }}
                            </dt>
                            <dd class="text-gray-900">
                                <div v-if="Array.isArray(value)">
                                    <ul v-if="value.length > 0" class="list-disc list-inside">
                                        <li v-for="(item, index) in value" :key="index">{{ item }}</li>
                                    </ul>
                                    <span v-else class="text-gray-500 italic">No items defined</span>
                                </div>
                                <div v-else-if="typeof value === 'object' && value !== null && Object.keys(value).length > 0" class="bg-gray-50 rounded-lg p-4 space-y-2 border">
                                    <div v-for="(subValue, subKey) in value" :key="subKey">
                                        <span class="text-gray-600 text-sm">{{ appUtils.formatFieldName(subKey) }}:</span>
                                        <span class="text-gray-900 ml-2">{{ subValue }}</span>
                                    </div>
                                </div>
                                <div v-else-if="key.includes('Objectives') || key.includes('Scope') || key.includes('Indicators') || key.includes('Governance') || key.includes('Funding') || key.includes('Reporting') || key.includes('businessInfo')" class="whitespace-pre-wrap">{{ value || 'Not specified' }}</div>
                                <span v-else class="text-gray-900">{{ value || 'Not specified' }}</span>
                            </dd>
                        </div>
                    </div>
                </div>
            </section>

            <!-- People Tab -->
            <section v-if="activeTab === 'people'" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Team Members</h2>
                        <p class="text-gray-600 mt-1">Manage your innovation team and their roles</p>
                    </div>
                    <button @click="addPerson" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i data-lucide="user-plus" class="w-4 h-4"></i>
                        <span>Add Person</span>
                    </button>
                    <button @click="openAiModal('peopleList', null)" title="AI Assistant for People List" class="flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i data-lucide="bot" class="w-4 h-4"></i>
                        <span>AI</span>
                    </button>
                </div>

                <div v-if="appData.people.length === 0" class="text-center py-12">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="users" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <p class="text-gray-600">No team members added yet</p>
                </div>

                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="person in appData.people" :key="person.personId" class="bg-white rounded-xl border border-gray-200 p-6 card-hover shadow-sm">
                        <div class="flex items-start space-x-4">
                            <img :src="getPersonAvatar(person.personId)"
                                 :alt="person.personName || 'Person'"
                                 class="w-16 h-16 rounded-full object-cover border-2 border-gray-200">
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-gray-900 truncate flex items-center">
                                    <span class="tooltip-container">
                                        <i class="tooltip-icon">?</i>
                                        <span class="tooltip-text">{{ getFieldDescription('people.personName') }}</span>
                                    </span>
                                    {{ person.personName || 'N/A' }}
                                </h3>
                                <p class="text-gray-700 text-sm mb-3">{{ person.personDescription || 'No description' }}</p>
                                <div v-if="person.personUrl" class="mb-4">
                                    <a :href="person.personUrl" target="_blank" class="inline-flex items-center space-x-1 text-blue-600 hover:text-blue-700 text-sm">
                                        <i data-lucide="external-link" class="w-3 h-3"></i>
                                        <span>View Profile</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-4 pt-4 border-t border-gray-200 hover-actions">
                             <button @click="viewItem(person, 'person')" class="flex items-center space-x-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1.5 rounded-lg text-sm transition-colors">
                                <i data-lucide="eye" class="w-3 h-3"></i>
                                <span>View</span>
                            </button>
                            <button @click="editPerson(person)" class="flex items-center space-x-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg text-sm transition-colors" title="Edit Person">
                                <i data-lucide="edit" class="w-3 h-3"></i>
                                <span>Edit</span>
                            </button>
                            <button @click="openAiModal('personItem', person)" title="AI Assistant for {{ person.personName }}" class="flex items-center space-x-1 bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1.5 rounded-lg text-sm transition-colors">
                                <i data-lucide="bot" class="w-3 h-3"></i>
                                <span>AI</span>
                            </button>
                            <button @click="deletePerson(person.personId)" class="flex items-center space-x-1 bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg text-sm transition-colors" title="Delete Person">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                <span>Delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Opportunities Tab -->
            <section v-if="activeTab === 'opportunities'" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Opportunities</h2>
                        <p class="text-gray-600 mt-1">Discover and track innovation opportunities</p>
                    </div>
                    <button @click="addOpportunity" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>Add Opportunity</span>
                    </button>
                    <button @click="openAiModal('opportunityList', null)" title="AI Assistant for Opportunities List" class="flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i data-lucide="bot" class="w-4 h-4"></i>
                        <span>AI</span>
                    </button>
                </div>

                <!-- Filter and Sort Controls -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4 md:space-y-0 md:flex md:items-end md:space-x-4">
                    <div class="flex-grow">
                        <label for="oppFilterName" class="block text-sm font-medium text-gray-700">Filter by Name</label>
                        <input type="text" v-model="opportunityFilterName" id="oppFilterName" class="form-input mt-1 block w-full" placeholder="Enter name...">
                    </div>
                    <div class="flex-grow">
                        <label for="oppFilterProposer" class="block text-sm font-medium text-gray-700">Filter by Proposer</label>
                        <select v-model="opportunityFilterProposerId" id="oppFilterProposer" class="form-select mt-1 block w-full">
                            <option value="">All Proposers</option>
                            <option v-for="person in appData.people" :key="person.personId" :value="person.personId">{{ person.personName }}</option>
                        </select>
                    </div>
                    <div class="flex-grow">
                        <label for="oppFilterStatus" class="block text-sm font-medium text-gray-700">Filter by Status</label>
                         <select v-model="opportunityFilterStatus" id="oppFilterStatus" class="form-select mt-1 block w-full">
                            <option value="">All Statuses</option>
                            <option v-for="status in (appData.program && appData.program.programDefaultOpportunityStatuses || APP_SCHEMA.definitions.opportunity.properties.opportunityStatus.enum)" :key="status" :value="status">{{ status }}</option>
                        </select>
                    </div>
                    <button @click="clearOpportunityFilters" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-gray-300 w-full md:w-auto">
                        Clear Filters
                    </button>
                </div>

                <div v-if="filteredAndSortedOpportunities.length === 0" class="text-center py-12">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="search-x" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <p class="text-gray-600">No opportunities match your current filters.</p>
                </div>

                <div v-else class="space-y-3">
                     <!-- Sort Headers -->
                    <div class="flex justify-between items-center text-xs text-gray-500 font-medium px-3 py-2 border-b bg-gray-50 rounded-t-lg">
                        <div class="flex-1 cursor-pointer hover:text-gray-800" @click="setOpportunitySort('opportunityName')">
                            Name
                            <i v-if="opportunitySortField === 'opportunityName'" :data-lucide="opportunitySortOrder === 'asc' ? 'arrow-up-az' : 'arrow-down-za'" class="sort-icon"></i>
                        </div>
                        <div class="w-1/4 cursor-pointer hover:text-gray-800 text-center" @click="setOpportunitySort('opportunityProposerId')">
                            Proposer
                             <i v-if="opportunitySortField === 'opportunityProposerId'" :data-lucide="opportunitySortOrder === 'asc' ? 'arrow-up-az' : 'arrow-down-za'" class="sort-icon"></i>
                        </div>
                         <div class="w-1/6 cursor-pointer hover:text-gray-800 text-center" @click="setOpportunitySort('opportunityStatus')">
                            Status
                            <i v-if="opportunitySortField === 'opportunityStatus'" :data-lucide="opportunitySortOrder === 'asc' ? 'arrow-up-az' : 'arrow-down-za'" class="sort-icon"></i>
                        </div>
                        <div class="w-1/6 cursor-pointer hover:text-gray-800 text-center" @click="setOpportunitySort('opportunityPriority')">
                            Priority
                            <i v-if="opportunitySortField === 'opportunityPriority'" :data-lucide="opportunitySortOrder === 'asc' ? 'arrow-up-0-9' : 'arrow-down-9-0'" class="sort-icon"></i>
                        </div>
                        <div class="w-1/6 text-right">Actions</div>
                    </div>

                    <div v-for="opp in filteredAndSortedOpportunities" :key="opp.opportunityId"
                         class="bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-150 card-hover">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center p-4">
                            <div class="flex-1 mb-3 md:mb-0 md:mr-4 min-w-0">
                                <h3 class="text-lg font-semibold text-blue-600" :title="opp.opportunityName">{{ opp.opportunityName || 'N/A' }}</h3>
                                <p class="text-xs text-gray-500">ID: {{ opp.opportunityId }}</p>
                            </div>
                            <div class="w-full md:w-1/4 text-sm text-gray-700 mb-2 md:mb-0 md:text-center" :title="getPersonName(opp.opportunityProposerId)">
                                {{ getPersonName(opp.opportunityProposerId) }}
                            </div>
                             <div class="w-full md:w-1/6 flex justify-start md:justify-center mb-3 md:mb-0">
                                <span :class="appUtils.getPhaseClass(opp.opportunityStatus)" class="status-badge">
                                    {{ opp.opportunityStatus || 'N/A' }}
                                </span>
                            </div>
                            <div class="w-full md:w-1/6 flex justify-start md:justify-center mb-3 md:mb-0">
                                <span :class="appUtils.getPriorityClass(opp.opportunityPriority)" class="status-badge">
                                    {{ opp.opportunityPriority !== undefined ? opp.opportunityPriority : 'N/A' }}
                                </span>
                            </div>
                            <div class="w-full md:w-1/6 flex justify-end space-x-2 items-center hover-actions">
                                 <button @click="viewItem(opp, 'opportunity')" class="p-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-md transition-colors" title="View Opportunity">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                </button>
                                <button @click="editOpportunity(opp)" class="p-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md transition-colors" title="Edit Opportunity">
                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                </button>
                                <button @click="openAiModal('opportunityItem', opp)" title="AI Assistant for {{ opp.opportunityName }}" class="p-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-md transition-colors">
                                    <i data-lucide="bot" class="w-4 h-4"></i>
                                </button>
                                <button @click="deleteOpportunity(opp.opportunityId)" class="p-1.5 bg-red-100 hover:bg-red-200 text-red-600 rounded-md transition-colors" title="Delete Opportunity">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <div class="px-4 pb-3 pt-2 border-t border-gray-100" v-if="opp.opportunityDescription">
                             <p class="text-sm text-gray-600 leading-relaxed">{{ opp.opportunityDescription.length > 150 ? opp.opportunityDescription.substring(0, 150) + '...' : opp.opportunityDescription }}</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Initiatives Tab -->
            <section v-if="activeTab === 'initiatives'" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">iNNitiatives</h2>
                        <p class="text-gray-600 mt-1">Track and manage your innovation initiatives</p>
                    </div>
                    <button @click="addInitiative" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>Add Initiative</span>
                    </button>
                    <button @click="openAiModal('initiativeList', null)" title="AI Assistant for Initiatives List" class="flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i data-lucide="bot" class="w-4 h-4"></i>
                        <span>AI</span>
                    </button>
                </div>

                <div v-if="appData.initiatives.length === 0" class="text-center py-12">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="zap" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <p class="text-gray-600">No initiatives created yet</p>
                </div>

                <div v-else class="space-y-4">
                     <!-- Sort Headers -->
                    <div class="flex justify-between items-center text-xs text-gray-500 font-medium px-6 py-2 border-b bg-gray-50 rounded-t-lg">
                        <div class="flex-1 cursor-pointer hover:text-gray-800" @click="setInitiativeSort('initiativeName')">
                            Name
                            <i v-if="initiativeSortField === 'initiativeName'" :data-lucide="initiativeSortOrder === 'asc' ? 'arrow-up-az' : 'arrow-down-za'" class="sort-icon"></i>
                        </div>
                        <div class="w-1/4 cursor-pointer hover:text-gray-800 text-center" @click="setInitiativeSort('initiativePhase')">
                            Phase
                             <i v-if="initiativeSortField === 'initiativePhase'" :data-lucide="initiativeSortOrder === 'asc' ? 'arrow-up-az' : 'arrow-down-za'" class="sort-icon"></i>
                        </div>
                         <div class="w-1/6 cursor-pointer hover:text-gray-800 text-center" @click="setInitiativeSort('initiativeType')">
                            Type
                            <i v-if="initiativeSortField === 'initiativeType'" :data-lucide="initiativeSortOrder === 'asc' ? 'arrow-up-az' : 'arrow-down-za'" class="sort-icon"></i>
                        </div>
                        <div class="w-1/6 text-right">Actions</div>
                    </div>
                     <div v-for="init in filteredAndSortedInitiatives" :key="init.initiativeId"
                         class="bg-white rounded-xl border border-gray-200 shadow-sm initiative-card p-6 card-hover">
                        <div class="flex flex-col md:flex-row justify-between md:items-start">
                            <div class="flex-1 mb-4 md:mb-0 md:mr-6">
                                <div class="flex items-center mb-2">
                                    <h3 class="text-xl font-semibold text-blue-700 mr-3">{{ init.initiativeName || 'N/A' }}</h3>
                                    <span :class="appUtils.getPhaseClass(init.initiativePhase)" class="status-badge">
                                        {{ init.initiativePhase }}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-500 mb-1">Type: <span class="font-medium text-gray-700">{{ init.initiativeType }}</span></p>
                                <p class="text-sm text-gray-500 mb-1">Manager: <span class="font-medium text-gray-700">{{ getPersonName(init.initiativeManagerId) }}</span></p>
                                <p class="text-sm text-gray-500">Budget: <span class="font-medium text-gray-700">{{ appUtils.formatNumber(init.initiativeBudget) }}</span></p>
                            </div>
                            <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-2 flex-shrink-0 hover-actions">
                                 <button @click="viewItem(init, 'initiative')" class="w-full md:w-auto flex items-center justify-center space-x-2 bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                    <span>View</span>
                                </button>
                                <button @click="editInitiative(init)" class="w-full md:w-auto flex items-center justify-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors" title="Edit Initiative">
                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                    <span>Edit</span>
                                </button>
                                <button @click="openAiModal('initiativeItem', init)" title="AI Assistant for {{ init.initiativeName }}" class="w-full md:w-auto flex items-center justify-center space-x-1 bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                    <i data-lucide="bot" class="w-4 h-4"></i>
                                    <span>AI</span>
                                </button>
                                <button @click="deleteInitiative(init.initiativeId)" class="w-full md:w-auto flex items-center justify-center space-x-1 bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg text-sm transition-colors border border-red-200" title="Delete Initiative">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    <span>Delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Modal for Editing/Adding -->
        <div v-if="showModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
            <div class="relative mx-auto border border-gray-300 w-full max-w-5xl shadow-2xl rounded-xl bg-white modal-content">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-900">{{ modalTitle }}</h3>
                    <button @click="closeModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="p-6">
                    <form @submit.prevent="saveForm" class="space-y-6">
                        <div class="form-grid grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div v-for="field in currentFormFields" :key="field.key"
                                 :class="['form-field', field.key.includes('Objectives') || field.key.includes('Scope') || field.key.includes('Indicators') || field.key.includes('Governance') || field.key.includes('Funding') || field.key.includes('Reporting') || field.key.includes('Description') || field.key.includes('Problem') || field.key.includes('Solution') || field.key.includes('Value') || field.key.includes('Goals') || field.key.includes('NextSteps') || field.key.includes('Resources') || field.key.includes('Risks') || field.key.includes('Learnings') || field.key.includes('DecisionJustification') || field.key.includes('Notes') || field.key.includes('businessInfo') || field.isSimpleStringArray ? 'lg:col-span-2' : '']">
                                <label :for="field.key" class="form-label flex items-center">
                                    <span class="tooltip-container">
                                        <i class="tooltip-icon cursor-pointer" @click.stop="showHelp(field.key, currentEditType)">?</i>
                                        <span class="tooltip-text">{{ field.description }} Click Icon for More Info</span>
                                    </span>
                                    {{ field.title }}
                                </label>

                                <!-- Text Input -->
                                <input v-if="field.type === 'string' && !field.enum && field.format !== 'textarea' && !field.isSimpleStringArray && !field.relationshipType"
                                       :id="field.key"
                                       v-model="formData[field.key]"
                                       :type="field.format === 'uri' ? 'url' : field.format === 'date' ? 'date' : 'text'"
                                       :readonly="field.readonly"
                                       class="form-input"
                                       :class="{ 'bg-gray-100 text-gray-500 cursor-not-allowed': field.readonly }">

                                <!-- Textarea -->
                                <textarea v-else-if="field.type === 'string' && field.format === 'textarea' && !field.isSimpleStringArray"
                                          :id="field.key"
                                          v-model="formData[field.key]"
                                          rows="4"
                                          class="form-input form-textarea"></textarea>

                                <!-- Number Input -->
                                <input v-else-if="field.type === 'number' || field.type === 'integer'"
                                       :id="field.key"
                                       v-model.number="formData[field.key]"
                                       type="number"
                                       :min="field.minimum"
                                       :max="field.maximum"
                                       class="form-input">

                                <!-- Select -->
                                <select v-else-if="field.enum"
                                        :id="field.key"
                                        v-model="formData[field.key]"
                                        class="form-select">
                                    <option value="">Select {{ field.title }}</option>
                                    <option v-for="option in field.enum" :key="option" :value="option">{{ option }}</option>
                                </select>

                                <!-- Special Select for Person References -->
                                <select v-else-if="field.relationshipType === 'person'"
                                        :id="field.key"
                                        v-model="formData[field.key]"
                                        class="form-select">
                                    <option value="">Select Person</option>
                                    <option v-for="person in (appData.people || [])" :key="person.personId" :value="person.personId">
                                        {{ person.personName }} ({{ person.personId }})
                                    </option>
                                </select>

                                <!-- Special Select for Opportunity References -->
                                <select v-else-if="field.relationshipType === 'opportunity'"
                                        :id="field.key"
                                        v-model="formData[field.key]"
                                        class="form-select">
                                    <option value="">Select Opportunity</option>
                                    <option v-for="opp in (appData.opportunities || [])" :key="opp.opportunityId" :value="opp.opportunityId">
                                        {{ opp.opportunityName }} ({{ opp.opportunityId }})
                                    </option>
                                </select>

                                <!-- Array Input (JSON Textarea - fallback) -->
                                <textarea v-else-if="field.type === 'array' && !field.isSimpleStringArray"
                                          :id="field.key"
                                          v-model="formData[field.key + '_json']"
                                          rows="3"
                                          class="form-input form-textarea"
                                          placeholder='Enter JSON array, e.g., ["item1", "item2"]'></textarea>

                                <!-- User-Friendly Array Input for Simple String Arrays -->
                                <div v-else-if="field.isSimpleStringArray">
                                    <div v-for="(item, index) in formData[field.key]" :key="index" class="array-item-input-container">
                                        <input type="text" v-model="formData[field.key][index]" class="form-input array-item-input" :placeholder="`Item ${index + 1}`">
                                        <button @click.prevent="removeArrayItem(field.key, index)" type="button" class="p-2 text-red-500 hover:text-red-700">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    <button @click.prevent="addArrayItem(field.key)" type="button" class="mt-2 flex items-center space-x-1 text-sm text-blue-600 hover:text-blue-800">
                                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                        <span>Add Item</span>
                                    </button>
                                </div>

                            </div>
                        </div>
                    </form>
                </div>
                <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                    <button @click="closeModal" class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors">
                        Cancel
                    </button>
                    <button @click="saveForm" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                        Save
                    </button>
                    <button v-if="showSaveAndDownload" @click="saveAndDownload" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                        Save & Export
                    </button>
                </div>
            </div>
        </div>

         <!-- Modal for Viewing Item -->
        <div v-if="showViewModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
            <div class="relative mx-auto border border-gray-300 w-full max-w-3xl shadow-2xl rounded-xl bg-white">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-900">{{ viewModalTitle }}</h3>
                    <button @click="closeViewModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="view-item-modal-content">
                    <div v-if="currentViewItem">
                        <div v-for="field in currentViewItemFields" :key="field.key" class="field-display">
                            <div class="field-label">{{ field.title }}</div>
                            <div class="field-value">
                                <div v-if="Array.isArray(currentViewItem[field.key])">
                                    <ul v-if="currentViewItem[field.key].length > 0" class="list-disc list-inside">
                                        <li v-for="(item, index) in currentViewItem[field.key]" :key="index">{{ item }}</li>
                                    </ul>
                                    <span v-else class="text-gray-500 italic">No items defined</span>
                                </div>
                                <div v-else-if="field.relationshipType === 'person'">
                                     <span v-if="currentViewItem[field.key]" @click="viewItem(getPerson(currentViewItem[field.key]), 'person')" class="text-blue-600 hover:underline cursor-pointer">
                                        {{ getPersonName(currentViewItem[field.key]) }} ({{ currentViewItem[field.key] }})
                                    </span>
                                    <span v-else class="text-gray-500 italic">Not specified</span>
                                </div>
                                <div v-else-if="field.relationshipType === 'opportunity'">
                                     <span v-if="currentViewItem[field.key]" @click="viewItem(getOpportunity(currentViewItem[field.key]), 'opportunity')" class="text-blue-600 hover:underline cursor-pointer">
                                        {{ getOpportunityName(currentViewItem[field.key]) }} ({{ currentViewItem[field.key] }})
                                    </span>
                                    <span v-else class="text-gray-500 italic">Not specified</span>
                                </div>
                                <span v-else>{{ currentViewItem[field.key] || 'Not specified' }}</span>
                            </div>
                        </div>

                        <div v-if="relatedItems.length > 0" class="related-items-section">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Related Items</h4>
                            <div class="related-items-grid">
                                <div v-for="related in relatedItems" :key="related.id" @click="viewItem(related.item, related.type)" class="related-item-card">
                                    <p class="related-item-title">{{ related.name }}</p>
                                    <p class="related-item-type">{{ related.type.charAt(0).toUpperCase() + related.type.slice(1) }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

         <!-- Modal for Help Documentation -->
        <div v-if="showHelpModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
            <div class="relative mx-auto border border-gray-300 w-full max-w-3xl shadow-2xl rounded-xl bg-white">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-900">{{ helpModalTitle }}</h3>
                    <button @click="closeHelpModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="view-item-modal-content" v-html="renderedHelpContent">
                </div>
            </div>
        </div>

    <!-- AI Assistant Modal -->
    <div v-if="showAiModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="relative mx-auto border border-gray-300 w-full max-w-3xl shadow-2xl rounded-xl bg-white modal-content">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">AI Assistant <span v-if="aiModalContextInfo" class="text-base font-normal text-gray-600">- {{ aiModalContextInfo }}</span></h3>
                <button @click="closeAiModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="aiModalFullPromptTextarea" class="block text-sm font-medium text-gray-700 mb-1">Full Prompt (for copy-pasting):</label>
                    <textarea id="aiModalFullPromptTextarea" v-model="aiModalFullPrompt" rows="15" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-xs"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <h4 class="text-md font-semibold mb-1 text-gray-700">Application JSON (Snapshot):</h4>
                        <pre v-text="aiModalAppJsonString" class="bg-gray-50 p-2.5 rounded-md overflow-x-auto max-h-60 border border-gray-200 text-xs"></pre>
                    </div>
                    <div>
                        <h4 class="text-md font-semibold mb-1 text-gray-700">Contextual Questions:</h4>
                        <div v-html="aiModalContextQuestionsHtml" class="bg-gray-50 p-2.5 rounded-md max-h-60 overflow-y-auto border border-gray-200 text-xs prose prose-sm"></div>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row justify-around items-center pt-4 border-t mt-4 space-y-2 sm:space-y-0 sm:space-x-3">
                    <a href="https://chat.openai.com" target="_blank" class="text-blue-600 hover:text-blue-700 font-semibold text-sm">ChatGPT</a>
                    <a href="https://gemini.google.com" target="_blank" class="text-blue-600 hover:text-blue-700 font-semibold text-sm">Gemini</a>
                    <a href="https://claude.ai" target="_blank" class="text-blue-600 hover:text-blue-700 font-semibold text-sm">Claude</a>
                </div>
            </div>
        </div>
    </div>

    </div> <!-- End of #app -->

    <script>
        const { createApp } = Vue; // Vue import

        // Initialize Lucide icons first
        // document.addEventListener('DOMContentLoaded', function() {
        //     lucide.createIcons();
        // }); // This is commented out as Vue's mounted/updated hooks handle icons.

        // --- APPLICATION SCHEMA ---
        const APP_SCHEMA = {
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "iNNitiatives Data Schema",
  "type": "object",
  "properties": {
    "program": { "$ref": "#/definitions/programConfiguration" },
    "people": { "type": "array", "items": { "$ref": "#/definitions/person" } },
    "opportunities": { "type": "array", "items": { "$ref": "#/definitions/opportunity" } },
    "initiatives": { "type": "array", "items": { "$ref": "#/definitions/initiative" } }
  },
  "required": ["program", "people", "opportunities", "initiatives"],
  "definitions": {
    "programConfiguration": {
      "type": "object",
      "title": "Program Configuration",
      "properties": {
        "programName": { "type": "string", "title": "Program Name", "description": "The official name of the innovation program within the organization. This helps identify and brand the overall innovation effort.", "default": "My Innovation Program" },
        "programObjectives": { "type": "string", "title": "Program Objectives", "description": "Key strategic goals the innovation program aims to achieve, encompassing its long-term vision, core mission, and primary purpose. These measurable targets align innovation efforts with the organization's broader strategy.", "format": "textarea" },
        "programScope": { "type": "string", "title": "Program Scope", "description": "The defined boundaries and areas of focus for the innovation program. This clarifies what is included and excluded from the program's initiatives.", "format": "textarea" },
        "programIndicators": { "type": "string", "title": "Program Indicators", "description": "Metrics used to measure the success and progress of the overall innovation program. These quantify achievement against strategic objectives and the program's health.", "format": "textarea" },
        "programGovernance": { "type": "string", "title": "Program Governance", "description": "Describes the decision-making processes, defined roles, and clear responsibilities within the innovation program. It ensures clarity on how projects are approved, reviewed, and managed.", "format": "textarea" },
        "programFunding": { "type": "string", "title": "Program Funding", "description": "Explains how innovation initiatives within the program are financed, including sources of funding, allocation rules, and budgetary considerations.", "format": "textarea" },
        "programStages": {
          "type": "array",
          "items": { "type": "string" },
          "title": "Program Stages",
          "description": "The predefined stages that an innovation initiative progresses through, from idea generation to validated concept. These stages provide a structured path for managing innovation.",
          "default": ["Idea Definition", "Concept Design", "Prototype Development", "Validation", "Pilot Testing", "Launched", "Scaling", "On Hold", "Cancelled"]
        },
        "programReporting": { "type": "string", "title": "Program Reporting", "description": "The frequency and format for reporting on the progress and outcomes of the innovation program to relevant stakeholders. This ensures transparency and accountability." },
        "programDefaultOpportunityStatuses": { "type": "array", "items": { "type": "string" }, "title": "Program Default Opportunity Statuses", "description": "Predefined status values for opportunities within the program. These categorize the current state of an identified innovation opportunity.", "default": ["Identified", "Under Review", "Prioritized", "Archived"] },
        "programDefaultInitiativeTypes": { "type": "array", "items": { "type": "string" }, "title": "Program Default Initiative Types", "description": "Predefined categories for innovation initiatives. These help classify projects based on their nature or focus area.", "default": ["New Product Development", "Process Improvement", "Technology Exploration", "Market Research", "Partnership Development", "Platform Enhancement", "Sustainability Initiative"] }
      },
      "required": ["programName", "programObjectives", "programStages", "programDefaultOpportunityStatuses", "programDefaultInitiativeTypes"]
    },
    "person": {
      "type": "object",
      "title": "Person",
      "properties": {
        "personId": { "type": "string", "title": "Person ID", "description": "A unique identifier for each individual associated with the innovation program. This ID ensures consistent referencing across the application." },
        "personName": { "type": "string", "title": "Person Name", "description": "The full name of the person. This is their common identification within the organization." },
        "personDescription": { "type": "string", "title": "Person Role/Short Bio", "description": "A brief description of the person's role, title, department, or a short biography within the organization. This helps clarify their contribution and expertise.", "format": "textarea" },
        "personRole": {
          "type": "string",
          "title": "Person Role",
          "description": "The defined role of the person within the context of the innovation program. This helps delineate responsibilities and interaction levels within the application.",
          "enum": ["Innovation Manager", "Innovation Sponsor", "Team Member", "Collaborator", "Observer"]
        },
        "personUrl": { "type": "string", "format": "uri", "title": "Person Profile URL", "description": "A link to an external profile or internal directory page for the person, if available. This can provide additional context or contact information." },
        "personImageUrl": { "type": "string", "format": "uri", "title": "Person Image URL", "description": "A URL to a profile picture or avatar of the person. This can enhance visual identification within the application." }
      },
      "required": ["personId", "personName", "personRole"]
    },
    "opportunity": {
      "type": "object",
      "title": "Opportunity",
      "properties": {
        "opportunityId": { "type": "string", "title": "Opportunity ID", "description": "A unique identifier for each innovation opportunity. This ID allows for distinct tracking and referencing throughout its lifecycle." },
        "opportunityName": { "type": "string", "title": "Opportunity Name", "description": "A concise and clear name for the innovation opportunity. This serves as a quick reference point." },
        "opportunityDescription": { "type": "string", "title": "Opportunity Description", "description": "A detailed explanation of the innovation opportunity, including any context or background that is relevant but doesn't fit into other specific fields. This is a general catchment for comprehensive information.", "format": "textarea" },
        "opportunityProblem": { "type": "string", "title": "Opportunity Problem", "description": "A clear and concise description of the specific problem, need, or unmet demand that this opportunity represents. This is crucial for applying Design Thinking principles of 'Define'.", "format": "textarea" },
        "opportunitySource": { "type": "string", "title": "Opportunity Source", "description": "Indicates where the opportunity was identified or originated from (e.g., Customer Feedback, Market Trend, Internal Brainstorm, Competitor Analysis). This helps trace the origin of insights.", "enum": ["Customer Feedback", "Market Trend", "Internal Brainstorm", "Competitor Analysis", "Technology Scouting", "Employee Idea", "Other"] },
        "opportunityStakeholders": { "type": "string", "title": "Opportunity Stakeholders", "description": "Key individuals or groups who have a vested interest in or are affected by this opportunity. Understanding stakeholders is vital for broader context and potential impact.", "format": "textarea" },
        "opportunityProposerId": {
          "type": "string",
          "title": "Opportunity Proposer ID",
          "description": "The unique ID of the person who initially proposed or identified this innovation opportunity. This links the opportunity to its originator.",
          "relationshipType": "person"
        },
        "opportunityPriority": { "type": "integer", "title": "Opportunity Priority", "minimum": 0, "maximum": 10, "description": "A numerical score (0-10) indicating the relative importance or urgency of the opportunity. Higher numbers represent higher priority." },
        "opportunityStatus": { "type": "string", "title": "Opportunity Status", "description": "The current state or status of the opportunity within the innovation pipeline (e.g., Identified, Under Review, Prioritized, Archived). This acts as a mini-gate for opportunities.", "enum": ["Identified", "Under Review", "Prioritized", "Archived"] },
        "opportunityDateIdentified": { "type": "string", "format": "date", "title": "Opportunity Date Identified", "description": "The date when the innovation opportunity was formally identified and registered in the system." },
        "opportunityLastUpdated": { "type": "string", "format": "date-time", "title": "Opportunity Last Updated", "description": "A timestamp indicating the last time any information related to this opportunity was modified. This field is automatically updated.", "readonly": true }
      },
      "required": ["opportunityId", "opportunityName", "opportunityProblem", "opportunityProposerId", "opportunityStatus", "opportunityDateIdentified", "opportunityLastUpdated"]
    },
    "initiative": {
      "type": "object",
      "title": "iNNitiative",
      "properties": {
        "initiativeId": { "type": "string", "title": "Initiative ID", "description": "A unique identifier for each innovation initiative or project. This ID allows for distinct tracking throughout its lifecycle." },
        "initiativeName": { "type": "string", "title": "Initiative Name", "description": "A descriptive and concise name for the innovation initiative. This is its primary identifier." },
        "initiativeType": { "type": "string", "title": "Initiative Type", "description": "The category or nature of the innovation initiative (e.g., New Product, Process Improvement). This helps classify and group initiatives.", "enum": ["New Product Development", "Process Improvement", "Technology Exploration", "Market Research", "Partnership Development", "Platform Enhancement", "Sustainability Initiative"] },
        "initiativePhase": { "type": "string", "title": "Initiative Phase", "description": "The current phase of the innovation initiative within the defined innovation lifecycle. This indicates its progression and current stage according to a Stage-Gate approach.", "enum": ["Idea Definition", "Concept Design", "Prototype Development", "Validation", "Pilot Testing", "Launched", "Scaling", "On Hold", "Cancelled"] },
        "initiativeManagerId": {
          "type": "string",
          "title": "Initiative Manager ID",
          "description": "The unique ID of the person responsible for leading and managing this specific innovation initiative. This person oversees its progress and outcomes.",
          "relationshipType": "person"
        },
        "initiativeOpportunityId": {
          "type": "string",
          "title": "Initiative Linked Opportunity ID",
          "description": "The unique ID of the opportunity that this initiative aims to address. This creates a direct link between a defined problem and its proposed solution.",
          "relationshipType": "opportunity"
        },
        "initiativeUser": { "type": "string", "title": "Initiative Target User", "description": "The specific user or customer segment that this innovation initiative is designed to serve. This aligns with Design Thinking's focus on user-centricity (previously 'iNNitiativeCustomer')." },
        "initiativeProblem": { "type": "string", "title": "Initiative Problem", "description": "The specific problem or need that this initiative aims to solve with its proposed solution. This can be directly linked to an opportunity's problem statement or be a new problem identified for this initiative.", "format": "textarea" },
        "initiativeSolution": { "type": "string", "title": "Initiative Solution", "description": "An overview and detailed explanation of the solution being developed or implemented by this initiative. This encompasses what is being built, prototyped, or delivered.", "format": "textarea" },
        "initiativeValueProposition": { "type": "string", "title": "Initiative Value Proposition", "description": "The unique benefits or outcomes that this initiative is expected to deliver to its target users or the organization. This clarifies the 'why' behind the solution.", "format": "textarea" },
        "initiativeSolutionHypothesis": { "type": "string", "title": "Initiative Solution Hypothesis", "description": "The core assumption(s) about how the proposed solution will solve the problem and create value. This is a crucial element of the Lean Startup methodology, guiding experiments.", "format": "textarea" },
        "initiativeGoals": { "type": "string", "title": "Initiative Goals/Success Metrics", "description": "Specific, measurable, achievable, relevant, and time-bound goals that define how the success of this initiative will be measured. These can include KPIs for the initiative itself.", "format": "textarea" },
        "initiativeObjective": { "type": "string", "title": "Initiative Objective (Experiment)", "description": "The specific learning objective or hypothesis being tested with the current prototype or MVP. This drives the 'Measure' and 'Learn' parts of the Lean Startup cycle and the 'Test' phase of Design Thinking.", "format": "textarea" },
        "initiativeResults": { "type": "string", "title": "Initiative Results (Experiment)", "description": "The observed data, user feedback, and outcomes gathered from testing the prototype or MVP. This captures the concrete evidence from experimentation, feeding into the 'Measure' phase of Lean Startup.", "format": "textarea" },
        "initiativeLearnings": { "type": "string", "title": "Initiative Learnings", "description": "Key insights and discoveries gained from the experiment's results. This is the 'Learn' part of the Lean Startup cycle, informing subsequent decisions and iterations.", "format": "textarea" },
        "initiativeDecision": { "type": "string", "title": "Initiative Decision", "description": "The critical Go/No-Go decision taken after evaluating the experiment's results and learnings. This represents a 'Gate' in the Stage-Gate process, determining the next steps for the initiative.", "enum": ["Persevere", "Pivot", "Discard", "Validated for Handover"] },
        "initiativeDecisionJustification": { "type": "string", "title": "Initiative Decision Justification", "description": "The rationale and reasoning behind the decision made after the experiment. This provides transparency and a historical record for the choice made.", "format": "textarea" },
        "initiativeNextSteps": { "type": "string", "title": "Initiative Next Steps", "description": "The immediate actions or planned activities following the current phase or decision point. This reflects the iterative nature of Agile and Lean approaches.", "format": "textarea" },
        "initiativeBudget": { "type": "number", "title": "Initiative Budget ()", "description": "The allocated or estimated financial resources for this innovation initiative. This includes costs for development, testing, and other related expenses.", "minimum": 0 },
        "initiativeResources": { "type": "string", "title": "Initiative Resources Needed", "description": "A description of key non-financial resources required for the initiative, such as specific personnel, tools, equipment, or external partnerships.", "format": "textarea" },
        "initiativeRisks": { "type": "string", "title": "Initiative Risks & Mitigation", "description": "Identification of potential risks that could impact the initiative's success, along with proposed plans or strategies to mitigate those risks.", "format": "textarea" },
        "initiativeDateRegistered": { "type": "string", "format": "date", "title": "Initiative Date Registered", "description": "The date when the innovation initiative was formally registered in the system." },
        "initiativeStartDate": { "type": "string", "format": "date", "title": "Initiative Start Date", "description": "The actual or estimated start date of the initiative or its current phase. This helps in tracking timelines." },
        "initiativeEndDate": { "type": "string", "format": "date", "title": "Initiative End Date", "description": "The actual or estimated end date of the initiative or its current phase. This helps in tracking timelines and project completion.", "format": "date" },
        "initiativeLastUpdated": { "type": "string", "format": "date-time", "title": "Initiative Last Updated", "description": "A timestamp indicating the last time any information related to this initiative was modified. This field is automatically updated.", "readonly": true },
        "initiativeNotes": { "type": "string", "title": "Initiative Additional Notes", "description": "Any other relevant notes, comments, or supplementary information pertaining to the initiative that does not fit into other structured fields.", "format": "textarea" }
      },
      "required": [
        "initiativeId",
        "initiativeName",
        "initiativeType",
        "initiativePhase",
        "initiativeManagerId",
        "initiativeOpportunityId",
        "initiativeDateRegistered",
        "initiativeLastUpdated",
        "initiativeSolutionHypothesis",
        "initiativeDecision"
      ]
    }
  }
};
        // --- END APPLICATION SCHEMA ---

        // --- UTILITY FUNCTIONS ---
        const appUtils = {
            formatFieldName(key) {
                return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            },
            generateUniqueId(prefix = 'item') {
                return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            },
            formatDate(dateString) {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        return 'Invalid Date';
                    }
                    // Format as YYYY-MM-DD
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                } catch {
                    return 'Invalid Date';
                }
            },
            formatNumber(num) {
                if (num === undefined || num === null || isNaN(Number(num))) return '0';
                return new Intl.NumberFormat().format(Number(num));
            },
            getPriorityClass(priority) {
                const p = Number(priority);
                if (isNaN(p)) return 'priority-low';
                if (p >= 8) return 'priority-high';
                if (p >= 5) return 'priority-medium';
                return 'priority-low';
            },
            getPhaseClass(phase) {
                switch (phase) {
                    case 'Launched':
                    case 'Scaling':
                    case 'Completed':
                        return 'phase-completed';
                    case 'On Hold':
                        return 'phase-hold';
                    case 'Cancelled':
                        return 'phase-cancelled';
                    case 'Idea Definition':
                    case 'Concept Design':
                    case 'Prototype Development':
                    case 'Validation':
                    case 'Pilot Testing':
                         return 'phase-active';
                    default:
                        return 'phase-active';
                }
            },
            getPhaseColor(phase) {
                switch (phase) {
                    case 'Launched':
                    case 'Scaling':
                    case 'Completed':
                        return 'bg-green-500';
                    case 'On Hold':
                    case 'Archived':
                        return 'bg-yellow-500';
                    case 'Cancelled':
                    case 'Discard':
                        return 'bg-red-500';
                    case 'Idea Definition':
                    case 'Concept Design':
                    case 'Prototype Development':
                    case 'Validation':
                    case 'Pilot Testing':
                    case 'Persevere':
                    case 'Pivot':
                    case 'Validated for Handover':
                         return 'bg-blue-500';
                    default:
                        return 'bg-blue-500';
                }
            }
        };
        // --- END UTILITY FUNCTIONS ---

        const app = createApp({ // Create app instance first
            // --- DATA ---
            data() {
                return {
                    activeTab: 'dashboard',
                    tabs: [
                        { id: 'dashboard', name: 'Dashboard', icon: 'home' },
                        { id: 'program', name: 'Program', icon: 'settings' },
                        { id: 'people', name: 'People', icon: 'users' },
                        { id: 'opportunities', name: 'Opportunities', icon: 'lightbulb' },
                        { id: 'initiatives', name: 'iNNitiatives', icon: 'zap' }
                    ],
                    appData: {
                        program: { programName: APP_SCHEMA.definitions.programConfiguration.properties.programName.default || "My Innovation Program" },
                        people: [],
                        opportunities: [],
                        initiatives: []
                    },
                    showModal: false,
                    modalTitle: '',
                    formData: {},
                    currentEditType: null,
                    currentEditId: null,
                    showSaveAndDownload: false,
                    currentFormFields: [],
                    notifications: [],
                    notificationId: 0,
                    // For Opportunities Tab
                    opportunityFilterName: '',
                    opportunityFilterProposerId: '',
                    opportunityFilterStatus: '',
                    opportunityFilterPriority: '',
                    opportunitySortField: 'opportunityName',
                    opportunitySortOrder: 'asc',
                    // For Initiatives Tab
                    initiativeSortField: 'initiativeName',
                    initiativeSortOrder: 'asc',
                    // For View Modal
                    showViewModal: false,
                    viewModalTitle: '',
                    currentViewItem: null,
                    currentViewItemFields: [],
                    relatedItems: [],
                    // For Help Modal
                    showHelpModal: false,
                    helpModalTitle: '',
                    renderedHelpContent: '',
                    documentation: {}, // Store parsed documentation here
                    // AI Modal Data Properties
                    showAiModal: false,
                    aiModalContextInfo: '', 
                    aiModalFullPrompt: '',   
                    aiModalAppJsonString: '', 
                    aiModalContextQuestionsHtml: ''
                }
            },
            // --- COMPUTED PROPERTIES ---
            computed: {
                isEmptyData() {
                    const defaultProgramName = APP_SCHEMA.definitions.programConfiguration.properties.programName.default || "My Innovation Program";
                    const hasNonDefaultProgram = this.appData.program &&
                        this.appData.program.programName &&
                        this.appData.program.programName !== defaultProgramName;

                    const hasMeaningfulData = (this.appData.people && this.appData.people.length > 0) ||
                                           (this.appData.opportunities && this.appData.opportunities.length > 0) ||
                                           (this.appData.initiatives && this.appData.initiatives.length > 0);

                    return !hasNonDefaultProgram && !hasMeaningfulData;
                },
                initiativePhases() { // For original summary list on dashboard
                    const phases = {};
                    (this.appData.initiatives || []).forEach(init => {
                        const phase = init.initiativePhase || 'Unknown';
                        phases[phase] = (phases[phase] || 0) + 1;
                    });
                    return Object.entries(phases).map(([name, count]) => ({ name, count }));
                },
                kanbanPhases() {
                    if (this.appData.program && this.appData.program.programStages && this.appData.program.programStages.length > 0) {
                        return this.appData.program.programStages;
                    }
                    return APP_SCHEMA.definitions.initiative.properties.initiativePhase.enum || [];
                },
                initiativesByPhase() {
                    const grouped = {};
                    this.kanbanPhases.forEach(phase => {
                        grouped[phase] = [];
                    });
                    (this.appData.initiatives || []).forEach(init => {
                        if (grouped[init.initiativePhase]) {
                            grouped[init.initiativePhase].push(init);
                        } else {
                            if (!grouped['Uncategorized']) {
                                grouped['Uncategorized'] = [];
                            }
                            grouped['Uncategorized'].push(init);
                        }
                    });
                    return grouped;
                },
                topOpportunities() {
                    return [...(this.appData.opportunities || [])]
                        .sort((a, b) => (b.opportunityPriority || 0) - (a.opportunityPriority || 0))
                        .slice(0, 3);
                },
                recentInitiatives() {
                    return [...(this.appData.initiatives || [])]
                        .sort((a, b) => new Date(b.initiativeLastUpdated || 0) - new Date(a.initiativeLastUpdated || 0))
                        .slice(0, 5);
                },
                filteredAndSortedOpportunities() {
                    let opportunities = [...(this.appData.opportunities || [])];

                    if (this.opportunityFilterName) {
                        opportunities = opportunities.filter(opp =>
                            opp.opportunityName.toLowerCase().includes(this.opportunityFilterName.toLowerCase())
                        );
                    }
                    if (this.opportunityFilterProposerId) {
                        opportunities = opportunities.filter(opp => opp.opportunityProposerId === this.opportunityFilterProposerId);
                    }
                     if (this.opportunityFilterStatus) {
                        opportunities = opportunities.filter(opp => opp.opportunityStatus === this.opportunityFilterStatus);
                    }
                    if (this.opportunityFilterPriority !== '') {
                        opportunities = opportunities.filter(opp => opp.opportunityPriority === parseInt(this.opportunityFilterPriority));
                    }

                    opportunities.sort((a, b) => {
                        let valA = a[this.opportunitySortField];
                        let valB = b[this.opportunitySortField];

                        if (this.opportunitySortField === 'opportunityPriority') {
                            valA = Number(valA || 0);
                            valB = Number(valB || 0);
                        } else if (typeof valA === 'string') {
                            valA = valA.toLowerCase();
                            valB = valB.toLowerCase();
                        }

                        let comparison = 0;
                        if (valA > valB) {
                            comparison = 1;
                        } else if (valA < valB) {
                            comparison = -1;
                        }
                        return this.opportunitySortOrder === 'asc' ? comparison : -comparison;
                    });
                    return opportunities;
                },
                 filteredAndSortedInitiatives() {
                    let initiatives = [...(this.appData.initiatives || [])];

                    // No filters specified for initiatives yet, just sorting

                    initiatives.sort((a, b) => {
                        let valA = a[this.initiativeSortField];
                        let valB = b[this.initiativeSortField];

                         if (typeof valA === 'string') {
                            valA = valA.toLowerCase();
                            valB = valB.toLowerCase();
                        }

                        let comparison = 0;
                        if (valA > valB) {
                            comparison = 1;
                        } else if (valA < valB) {
                            comparison = -1;
                        }
                        return this.initiativeSortOrder === 'asc' ? comparison : -comparison;
                    });
                    return initiatives;
                }
            },
            // --- METHODS ---
            methods: {
                closeAiModal() {
                    this.showAiModal = false;
                    // Optionally reset modal content if desired when closing
                    // this.aiModalContextInfo = '';
                    // this.aiModalFullPrompt = '';
                    // this.aiModalAppJsonString = '';
                    // this.aiModalContextQuestionsHtml = '';
                },

                async openAiModal(contextType, contextDataItem = null) {
                    this.showAiModal = true; // Show modal immediately with loading states
                    this.aiModalContextInfo = `Loading context for ${contextType}...`;
                    this.aiModalFullPrompt = 'Loading full prompt...';
                    this.aiModalAppJsonString = 'Loading application JSON...';
                    this.aiModalContextQuestionsHtml = '<p>Loading questions...</p>';
                    
                    // Ensure Lucide icons in the modal are processed if modal was hidden and icons are dynamic
                    this.$nextTick(() => {
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    });

                    try {
                        // 1. Set Context Info
                        let contextInfo = `Section: ${contextType}`;
                        let itemIdentifier = ''; // For placeholder replacement in questions
                        if (contextDataItem) {
                            if (contextType === 'program') {
                                itemIdentifier = contextDataItem.programName || 'Program';
                                contextInfo = `Program: ${itemIdentifier}`;
                            } else if (contextType.endsWith('Item') && contextDataItem) {
                                itemIdentifier = contextDataItem.personName || contextDataItem.opportunityName || contextDataItem.initiativeName || 'Item';
                                const typeName = contextType.replace('Item', '');
                                contextInfo = `Item: "${itemIdentifier}" (Type: ${typeName.charAt(0).toUpperCase() + typeName.slice(1)})`;
                            } else { // List context
                                const typeName = contextType.replace('List', '');
                                contextInfo = `List View: ${typeName.charAt(0).toUpperCase() + typeName.slice(1)}`;
                                itemIdentifier = typeName; // Use type for generic list questions
                            }
                        } else if (contextType) { // General section/list context
                            contextInfo = `Section: ${contextType.charAt(0).toUpperCase() + contextType.slice(1)}`;
                            itemIdentifier = contextType;
                        }
                        this.aiModalContextInfo = contextInfo;

                        // 2. Fetch prompt.md
                        const promptMdResponse = await fetch('./prompt.md'); // Relative to public/
                        if (!promptMdResponse.ok) throw new Error('Failed to load prompt.md');
                        const promptMdText = await promptMdResponse.text();

                        // 3. Prepare Application JSON
                        this.aiModalAppJsonString = JSON.stringify(this.appData, null, 2);

                        // 4. Fetch and Process prompt.json
                        let questionsStringForPrompt = "";
                        let questionsHtml = "<p>No specific questions for this context.</p>";
                        try {
                            const promptsJsonResponse = await fetch('./prompt.json'); // Relative to public/
                            if (!promptsJsonResponse.ok) throw new Error('Failed to load prompt.json');
                            const promptsData = await promptsJsonResponse.json();
                            
                            let promptKey = null;
                            if (contextType.includes('person') || contextType.includes('People')) promptKey = 'people_';
                            else if (contextType.includes('opportunity') || contextType.includes('Opportunities')) promptKey = 'Opportunities';
                            else if (contextType.includes('initiative') || contextType.includes('Initiatives')) promptKey = 'initiatives';
                            else if (contextType.includes('program')) promptKey = 'program'; // Assuming a 'program' key might exist or be added

                            if (promptKey && promptsData[promptKey]) {
                                let questionsArray = [];
                                if (contextType.endsWith('Item') && promptsData[promptKey].item) {
                                    questionsArray = promptsData[promptKey].item;
                                    questionsStringForPrompt += "\n\n--- ITEM-SPECIFIC CONTEXTUAL QUESTIONS ---\n";
                                } else if (promptsData[promptKey].list) {
                                    questionsArray = promptsData[promptKey].list;
                                    questionsStringForPrompt += "\n\n--- CONTEXTUAL QUESTIONS (for list/section) ---\n";
                                } else if (typeof promptsData[promptKey] === 'object' && !Array.isArray(promptsData[promptKey])) { // Handle if program key has direct questions
                                    questionsArray = promptsData[promptKey].questions || []; // Or some other structure
                                    questionsStringForPrompt += "\n\n--- CONTEXTUAL QUESTIONS ---\n";
                                }


                                if (questionsArray.length > 0) {
                                    questionsHtml = '<ul>';
                                    questionsArray.forEach(q => {
                                        let finalQuestion = q;
                                        if (itemIdentifier) {
                                            finalQuestion = q.replace(/{person_name}|{opportunity_name}|{initiative_name}|{program_name}/gi, itemIdentifier.replace(/\.\.\.$/, ''));
                                        }
                                        questionsHtml += `<li class="mb-1 p-1 bg-gray-100 rounded text-xs">${finalQuestion}</li>`; // Applied some styling
                                        questionsStringForPrompt += '- ' + finalQuestion + '\n';
                                    });
                                    questionsHtml += '</ul>';
                                }
                            }
                        } catch (e) {
                            console.error("Error processing prompt.json:", e);
                            questionsHtml = "<p>Error loading or processing contextual questions.</p>";
                            questionsStringForPrompt = "\nError loading contextual questions.\n";
                        }
                        this.aiModalContextQuestionsHtml = questionsHtml;

                        // 5. Construct Full Prompt
                        this.aiModalFullPrompt = `${promptMdText}\n\n--- CONTEXT ---\n${this.aiModalContextInfo}\n\n--- APPLICATION JSON ---\n${this.aiModalAppJsonString}${questionsStringForPrompt}`;

                    } catch (error) {
                        console.error('Error opening AI modal:', error);
                        this.aiModalFullPrompt = `Error loading content: ${error.message}`;
                        this.aiModalAppJsonString = `Error: ${error.message}`;
                        this.aiModalContextQuestionsHtml = `<p>Error: ${error.message}</p>`;
                        this.aiModalContextInfo = 'Error';
                    }
                },
                getFieldDescription(path) {
                    const parts = path.split('.');
                    if (parts.length === 2) {
                        const [sectionKey, fieldKey] = parts;
                        const sectionSchemaDefinition = APP_SCHEMA.properties[sectionKey];
                        let definition;

                        if (sectionSchemaDefinition && sectionSchemaDefinition.$ref) {
                            definition = APP_SCHEMA.definitions[sectionSchemaDefinition.$ref.split('/').pop()];
                        } else if (sectionSchemaDefinition && sectionSchemaDefinition.type === 'array' && sectionSchemaDefinition.items && sectionSchemaDefinition.items.$ref) {
                            definition = APP_SCHEMA.definitions[sectionSchemaDefinition.items.$ref.split('/').pop()];
                        }

                        if (definition && definition.properties && definition.properties[fieldKey]) {
                            return definition.properties[fieldKey].description || 'No description available.';
                        }
                    }
                    return 'No description available.';
                },
                getPerson(personId) {
                     return (this.appData.people || []).find(p => p.personId === personId);
                },
                getPersonName(personId) {
                    if (!personId) return 'Unknown';
                    const person = this.getPerson(personId);
                    return person ? person.personName : personId;
                },
                getPersonAvatar(personId) {
                    if (!personId) return `https://ui-avatars.com/api/?name=Unknown&background=64748b&color=fff&size=64`;
                    const person = this.getPerson(personId);
                    if (person && person.personImageUrl) return person.personImageUrl;
                    const name = person ? person.personName : personId;
                    return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3b82f6&color=fff&size=64`;
                },
                getPersonInitiativeCount(personId) {
                    return (this.appData.initiatives || []).filter(init => init.initiativeManagerId === personId).length;
                },
                 getOpportunity(opportunityId) {
                     return (this.appData.opportunities || []).find(o => o.opportunityId === opportunityId);
                 },
                getOpportunityName(opportunityId) {
                    if (!opportunityId) return 'No opportunity linked';
                    const opportunity = this.getOpportunity(opportunityId);
                    return opportunity ? opportunity.opportunityName : opportunityId;
                },
                isPersonReference(fieldKey) {
                    const personReferenceFields = ['opportunityProposerId', 'initiativeManagerId'];
                    if (personReferenceFields.includes(fieldKey)) return true;
                    return fieldKey.toLowerCase().includes('personid');
                },
                isOpportunityReference(fieldKey) {
                    const opportunityReferenceFields = ['initiativeOpportunityId'];
                    if (opportunityReferenceFields.includes(fieldKey)) return true;
                    return fieldKey.toLowerCase().includes('opportunityid');
                },
                showNotification(title, message, type = 'info') {
                    const notification = {
                        id: ++this.notificationId,
                        title,
                        message,
                        type,
                        show: false
                    };
                    this.notifications.push(notification);
                    setTimeout(() => {
                        notification.show = true;
                        this.$nextTick(() => { lucide.createIcons(); });
                    }, 100);
                    setTimeout(() => { this.removeNotification(notification.id); }, 10000);
                },
                removeNotification(id) {
                    const index = this.notifications.findIndex(n => n.id === id);
                    if (index > -1) {
                        this.notifications[index].show = false;
                        setTimeout(() => { this.notifications.splice(index, 1); }, 300);
                    }
                },

                loadDataFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            if (typeof jsonData === 'object' && jsonData !== null &&
                                'program' in jsonData && 'people' in jsonData &&
                                'opportunities' in jsonData && 'initiatives' in jsonData) {
                                this.appData = jsonData;
                                this.showNotification('Success', 'Data file loaded successfully!', 'success');
                            } else {
                                 this.showNotification('Error', 'Invalid data file: Missing one or more required top-level keys (program, people, opportunities, initiatives).', 'error');
                            }
                        } catch (error) {
                            this.showNotification('Error', `Error parsing JSON: ${error.message}`, 'error');
                        }
                        event.target.value = '';
                    };
                    reader.readAsText(file);
                },
                async loadSampleData() {
                    try {
                        const response = await fetch('./sample-data.json');
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const sampleData = await response.json();
                        this.appData = sampleData;
                        this.showNotification('Success', 'Sample data loaded successfully!', 'success');
                    } catch (error) {
                        this.showNotification('Error', `Error loading sample data: ${error.message}`, 'error');
                    }
                },
                exportData() {
                    try {
                        const now = new Date();
                        const timestamp = now.getFullYear() + '-' +
                            String(now.getMonth() + 1).padStart(2, '0') + '-' +
                            String(now.getDate()).padStart(2, '0') + '-' +
                            String(now.getHours()).padStart(2, '0') +
                            String(now.getMinutes()).padStart(2, '0') +
                            String(now.getSeconds()).padStart(2, '0');

                        const dataStr = JSON.stringify(this.appData, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `innit-data-${timestamp}.json`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        this.showNotification('Success', 'Data exported successfully!', 'success');
                    } catch (error) {
                        this.showNotification('Error', `Error exporting data: ${error.message}`, 'error');
                    }
                },

                addArrayItem(fieldKey) {
                    if (!this.formData[fieldKey] || !Array.isArray(this.formData[fieldKey])) {
                        this.formData[fieldKey] = [];
                    }
                    this.formData[fieldKey].push('');
                    this.$nextTick(() => lucide.createIcons() );
                },
                removeArrayItem(fieldKey, index) {
                    if (this.formData[fieldKey] && Array.isArray(this.formData[fieldKey])) {
                        this.formData[fieldKey].splice(index, 1);
                    }
                },
                generateFormFields(schemaDefinition) {
                    const fields = [];
                    const properties = schemaDefinition.properties || {};
                    const simpleStringArrayFields = [
                        'programStages',
                        'programDefaultOpportunityStatuses',
                        'programDefaultInitiativeTypes',
                        'initiativeGoals', // Assuming goals are a list
                        'initiativeNextSteps', // Assuming next steps are a list
                        'initiativeResources', // Assuming resources are a list
                        'initiativeRisks' // Assuming risks are a list
                    ];

                    for (const [key, prop] of Object.entries(properties)) {
                        let effectiveEnum = prop.enum;
                        if (this.currentEditType === 'initiative') {
                            if (key === 'initiativeType' && this.appData.program && this.appData.program.programDefaultInitiativeTypes && this.appData.program.programDefaultInitiativeTypes.length > 0) {
                                effectiveEnum = this.appData.program.programDefaultInitiativeTypes;
                            } else if (key === 'initiativePhase' && this.appData.program && this.appData.program.programStages && this.appData.program.programStages.length > 0) {
                                effectiveEnum = this.appData.program.programStages;
                            }
                        } else if (this.currentEditType === 'opportunity') {
                             if (key === 'opportunityStatus' && this.appData.program && this.appData.program.programDefaultOpportunityStatuses && this.appData.program.programDefaultOpportunityStatuses.length > 0) {
                                effectiveEnum = this.appData.program.programDefaultOpportunityStatuses;
                            }
                        }


                        fields.push({
                            key: key,
                            title: prop.title || appUtils.formatFieldName(key),
                            description: prop.description || 'No description available.',
                            type: prop.type,
                            format: prop.format,
                            enum: effectiveEnum,
                            minimum: prop.minimum,
                            maximum: prop.maximum,
                            readonly: prop.readonly || false,
                            relationshipType: prop.relationshipType,
                            isSimpleStringArray: prop.type === 'array' && prop.items && prop.items.type === 'string' && simpleStringArrayFields.includes(key)
                        });
                    }
                    fields.forEach(field => {
                        if ( (this.currentEditId && (field.key === 'personId' || field.key === 'opportunityId' || field.key === 'initiativeId')) || field.key === 'lastUpdated' || field.key === 'initiativeLastUpdated' || field.key === 'opportunityLastUpdated') {
                             field.readonly = true;
                        }
                        if (!this.currentEditId && (field.key === 'personId' || field.key === 'opportunityId' || field.key === 'initiativeId') && field.key !== 'lastUpdated' && field.key !== 'initiativeLastUpdated' && field.key !== 'opportunityLastUpdated') {
                             if (schemaDefinition.properties[field.key] && schemaDefinition.properties[field.key].readonly !== true) {
                             }
                        }
                    });
                    return fields;
                },
                prepareFormData(data, fields) {
                    const formData = { ...data };
                    fields.forEach(field => {
                        if (field.isSimpleStringArray) {
                            // For simple string arrays, convert newline separated string to array for editing
                            if (typeof data[field.key] === 'string') {
                                formData[field.key] = data[field.key].split('\n').map(item => item.trim()).filter(item => item !== '');
                            } else {
                                formData[field.key] = Array.isArray(data[field.key]) ? [...data[field.key]] : [];
                            }
                        } else if (field.type === 'array') {
                            formData[field.key + '_json'] = JSON.stringify(formData[field.key] || []);
                        }
                    });
                    return formData;
                },
                processFormData(formData, fields) {
                    const processedData = { ...formData };
                    let parseErrorOccurred = false;
                    fields.forEach(field => {
                        if (field.isSimpleStringArray) {
                             // For simple string arrays, convert array back to newline separated string for saving
                            processedData[field.key] = Array.isArray(formData[field.key]) ? formData[field.key].join('\n') : '';
                        } else if (field.type === 'array') {
                            try {
                                processedData[field.key] = JSON.parse(formData[field.key + '_json'] || '[]');
                            } catch (e) {
                                this.showNotification('Error', `Invalid JSON format for field: ${field.title}. Please correct it.`, 'error');
                                parseErrorOccurred = true;
                            }
                            delete processedData[field.key + '_json'];
                        }
                    });
                    return parseErrorOccurred ? null : processedData;
                },
                editProgram() {
                    this.modalTitle = 'Edit Program Configuration';
                    const schema = APP_SCHEMA.definitions.programConfiguration;
                    this.currentEditType = 'program';
                    this.currentEditId = null;
                    this.currentFormFields = this.generateFormFields(schema);
                    if (!this.appData.program || Object.keys(this.appData.program).length === 0) {
                        this.appData.program = { programName: APP_SCHEMA.definitions.programConfiguration.properties.programName.default || "My Innovation Program" };
                    }
                    this.formData = this.prepareFormData(this.appData.program, this.currentFormFields);
                    this.showSaveAndDownload = true;
                    this.showModal = true;
                },
                addPerson() {
                    this.modalTitle = 'Add New Person';
                    const schema = APP_SCHEMA.definitions.person;
                    this.currentEditType = 'person';
                    this.currentEditId = null;
                    this.currentFormFields = this.generateFormFields(schema);
                    let newPersonData = { personId: appUtils.generateUniqueId('PERSON') };
                    for(const key in schema.properties) {
                        if(schema.properties[key].default !== undefined && newPersonData[key] === undefined) {
                            newPersonData[key] = schema.properties[key].default;
                        }
                    }
                    this.formData = this.prepareFormData(newPersonData, this.currentFormFields);
                    this.showSaveAndDownload = true;
                    this.showModal = true;
                },
                editPerson(person) {
                    this.modalTitle = 'Edit Person';
                    const schema = APP_SCHEMA.definitions.person;
                    this.currentEditType = 'person';
                    this.currentEditId = person.personId;
                    this.currentFormFields = this.generateFormFields(schema);
                    this.formData = this.prepareFormData(person, this.currentFormFields);
                    this.showSaveAndDownload = true;
                    this.showModal = true;
                },
                deletePerson(personId) {
                    const linkedInitiatives = (this.appData.initiatives || []).filter(init => init.initiativeManagerId === personId).length;
                    const linkedOpportunities = (this.appData.opportunities || []).filter(opp => opp.opportunityProposerId === personId).length;
                    let warningMessage = `Are you sure you want to delete person ID: ${personId}? This action cannot be undone.`;

                    if (linkedInitiatives > 0 || linkedOpportunities > 0) {
                        warningMessage = `Warning: This person is linked to ${linkedInitiatives} initiative(s) and ${linkedOpportunities} opportunity(s). Deleting them will leave these records without a valid reference. Proceed with deletion?`;
                    }

                    if (confirm(warningMessage)) {
                        const index = (this.appData.people || []).findIndex(p => p.personId === personId);
                        if (index !== -1) {
                            this.appData.people.splice(index, 1);
                            this.showNotification('Success', `Person ${personId} deleted successfully!`, 'success');
                        } else {
                            this.showNotification('Error', `Person ${personId} not found.`, 'error');
                        }
                    }
                },
                addOpportunity() {
                    this.modalTitle = 'Add New Opportunity';
                    const schema = APP_SCHEMA.definitions.opportunity;
                    this.currentEditType = 'opportunity';
                    this.currentEditId = null;
                    this.currentFormFields = this.generateFormFields(schema);
                     const today = new Date().toISOString().split('T')[0];
                     let newOppData = { opportunityId: appUtils.generateUniqueId('OPP'), opportunityDateIdentified: today, opportunityLastUpdated: new Date().toISOString() };
                    for(const key in schema.properties) {
                        if(schema.properties[key].default !== undefined && newOppData[key] === undefined) {
                            newOppData[key] = schema.properties[key].default;
                        }
                         if(key === "opportunityPriority" && newOppData[key] === undefined) newOppData[key] = 0;
                         if(key === "opportunityStatus" && newOppData[key] === undefined) newOppData[key] = (this.appData.program && this.appData.program.programDefaultOpportunityStatuses && this.appData.program.programDefaultOpportunityStatuses.length > 0) ? this.appData.program.programDefaultOpportunityStatuses[0] : (schema.properties.opportunityStatus.enum ? schema.properties.opportunityStatus.enum[0] : '');
                    }
                    this.formData = this.prepareFormData(newOppData, this.currentFormFields);
                    this.showSaveAndDownload = true;
                    this.showModal = true;
                },
                editOpportunity(opportunity) {
                    this.modalTitle = 'Edit Opportunity';
                    const schema = APP_SCHEMA.definitions.opportunity;
                    this.currentEditType = 'opportunity';
                    this.currentEditId = opportunity.opportunityId;
                    this.currentFormFields = this.generateFormFields(schema);
                    this.formData = this.prepareFormData(opportunity, this.currentFormFields);
                    this.showSaveAndDownload = true;
                    this.showModal = true;
                },
                deleteOpportunity(opportunityId) {
                    const linkedInitiatives = (this.appData.initiatives || []).filter(init => init.initiativeOpportunityId === opportunityId).length;
                    let warningMessage = `Are you sure you want to delete opportunity ID: ${opportunityId}? This action cannot be undone.`;

                    if (linkedInitiatives > 0) {
                        warningMessage = `Warning: This opportunity is linked to ${linkedInitiatives} initiative(s). Deleting it will leave these initiatives without a valid reference. Proceed with deletion?`;
                    }

                    if (confirm(warningMessage)) {
                        const index = (this.appData.opportunities || []).findIndex(o => o.opportunityId === opportunityId);
                        if (index !== -1) {
                            this.appData.opportunities.splice(index, 1);
                            this.showNotification('Success', `Opportunity ${opportunityId} deleted successfully!`, 'success');
                        } else {
                            this.showNotification('Error', `Opportunity ${opportunityId} not found.`, 'error');
                        }
                    }
                },
                addInitiative() {
                    this.modalTitle = 'Add New iNNitiative';
                    const schema = APP_SCHEMA.definitions.initiative;
                    this.currentEditType = 'initiative';
                    this.currentEditId = null;
                    this.currentFormFields = this.generateFormFields(schema);
                    const today = new Date().toISOString().split('T')[0];
                    let newInitData = {
                        initiativeId: appUtils.generateUniqueId('INN'),
                        initiativeDateRegistered: today,
                        initiativeLastUpdated: new Date().toISOString()
                    };
                    for(const key in schema.properties) {
                        if(schema.properties[key].default !== undefined && newInitData[key] === undefined) {
                            newInitData[key] = schema.properties[key].default;
                        }
                         if(key === "initiativeBudget" && newInitData[key] === undefined) newInitData[key] = 0;
                         if(key === "initiativePhase" && newInitData[key] === undefined) newInitData[key] = (this.appData.program && this.appData.program.programStages && this.appData.program.programStages.length > 0) ? this.appData.program.programStages[0] : (schema.properties.initiativePhase.enum ? schema.properties.initiativePhase.enum[0] : '');
                         if(key === "initiativeType" && newInitData[key] === undefined) newInitData[key] = (this.appData.program && this.appData.program.programDefaultInitiativeTypes && this.appData.program.programDefaultInitiativeTypes.length > 0) ? this.appData.program.programDefaultInitiativeTypes[0] : (schema.properties.initiativeType.enum ? schema.properties.initiativeType.enum[0] : '');
                         if(key === "initiativeDecision" && newInitData[key] === undefined) newInitData[key] = (schema.properties.initiativeDecision.enum ? schema.properties.initiativeDecision.enum[0] : '');
                    }
                    this.formData = this.prepareFormData(newInitData, this.currentFormFields);
                    this.showSaveAndDownload = true;
                    this.showModal = true;
                },
                editInitiative(initiative) {
                    this.modalTitle = 'Edit iNNitiative';
                    const schema = APP_SCHEMA.definitions.initiative;
                    this.currentEditType = 'initiative';
                    this.currentEditId = initiative.initiativeId;
                    this.currentFormFields = this.generateFormFields(schema);
                    this.formData = this.prepareFormData(initiative, this.currentFormFields);
                    this.showSaveAndDownload = true;
                    this.showModal = true;
                },
                deleteInitiative(initiativeId) {
                    if (confirm(`Are you sure you want to delete iNNitiative ID: ${initiativeId}? This action cannot be undone.`)) {
                        const index = (this.appData.initiatives || []).findIndex(i => i.initiativeId === initiativeId);
                        if (index !== -1) {
                            this.appData.initiatives.splice(index, 1);
                            this.showNotification('Success', `Initiative ${initiativeId} deleted successfully!`, 'success');
                        } else {
                            this.showNotification('Error', `Initiative ${initiativeId} not found.`, 'error');
                        }
                    }
                },
                closeModal() {
                    this.showModal = false;
                    this.modalTitle = '';
                    this.formData = {};
                    this.currentEditType = null;
                    this.currentEditId = null;
                    this.showSaveAndDownload = false;
                    this.currentFormFields = [];
                },
                saveForm() {
                    this.performSave();
                },
                saveAndDownload() {
                    this.performSave();
                    this.$nextTick(() => {
                        this.exportData();
                    });
                },
                performSave() {
                    try {
                        let schemaDefinition;
                        let requiredFields = [];
                        const entityTitle = this.currentEditType.charAt(0).toUpperCase() + this.currentEditType.slice(1);

                        if (this.currentEditType === 'program') {
                            schemaDefinition = APP_SCHEMA.definitions.programConfiguration;
                        } else if (this.currentEditType === 'person') {
                            schemaDefinition = APP_SCHEMA.definitions.person;
                        } else if (this.currentEditType === 'opportunity') {
                            schemaDefinition = APP_SCHEMA.definitions.opportunity;
                        } else if (this.currentEditType === 'initiative') {
                            schemaDefinition = APP_SCHEMA.definitions.initiative;
                        }

                        if (schemaDefinition && schemaDefinition.required) {
                            requiredFields = schemaDefinition.required;
                        }

                        for (const fieldName of requiredFields) {
                            const fieldDefinition = schemaDefinition.properties[fieldName];
                            const fieldTitle = (fieldDefinition ? fieldDefinition.title : '') || appUtils.formatFieldName(fieldName);
                            const value = this.formData[fieldName];

                            if (value === null || value === undefined || (typeof value === 'string' && value.trim() === '')) {
                                 this.showNotification('Error', `Field "${fieldTitle}" is required for ${entityTitle}.`, 'error');
                                return;
                            }
                        }

                        const processedData = this.processFormData(this.formData, this.currentFormFields);
                        if (processedData === null) {
                            return;
                        }

                        if (this.currentEditType === 'program') {
                            this.appData.program = { ...this.appData.program, ...processedData };
                        } else if (this.currentEditType === 'person') {
                            if (!this.appData.people) this.appData.people = [];
                            if (this.currentEditId) {
                                const index = this.appData.people.findIndex(p => p.personId === this.currentEditId);
                                if (index !== -1) this.appData.people[index] = { ...this.appData.people[index], ...processedData };
                            } else {
                                this.appData.people.push(processedData);
                            }
                        } else if (this.currentEditType === 'opportunity') {
                            if (!this.appData.opportunities) this.appData.opportunities = [];
                            if (this.currentEditId) {
                                const index = this.appData.opportunities.findIndex(o => o.opportunityId === this.currentEditId);
                                if (index !== -1) this.appData.opportunities[index] = { ...this.appData.opportunities[index], ...processedData };
                            } else {
                                this.appData.opportunities.push(processedData);
                            }
                        } else if (this.currentEditType === 'initiative') {
                            if (!this.appData.initiatives) this.appData.initiatives = [];
                            processedData.initiativeLastUpdated = new Date().toISOString();
                            if (this.currentEditId) {
                                const index = this.appData.initiatives.findIndex(i => i.initiativeId === this.currentEditId);
                                if (index !== -1) this.appData.initiatives[index] = { ...this.appData.initiatives[index], ...processedData };
                            } else {
                                this.appData.initiatives.push(processedData);
                            }
                        }

                        this.closeModal();
                        this.showNotification('Success', `${entityTitle} data saved successfully!`, 'success');
                    } catch (error) {
                        this.showNotification('Error', `Error saving data: ${error.message}`, 'error');
                        console.error("Error in performSave:", error);
                    }
                },
                setOpportunitySort(field) {
                    if (this.opportunitySortField === field) {
                        this.opportunitySortOrder = this.opportunitySortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.opportunitySortField = field;
                        this.opportunitySortOrder = 'asc';
                    }
                    this.$nextTick(() => lucide.createIcons() );
                },
                clearOpportunityFilters() {
                    this.opportunityFilterName = '';
                    this.opportunityFilterProposerId = '';
                    this.opportunityFilterStatus = '';
                    this.opportunityFilterPriority = '';
                    this.$nextTick(() => lucide.createIcons() );
                },
                 setInitiativeSort(field) {
                    if (this.initiativeSortField === field) {
                        this.initiativeSortOrder = this.initiativeSortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.initiativeSortField = field;
                        this.initiativeSortOrder = 'asc';
                    }
                    this.$nextTick(() => lucide.createIcons() );
                },
                viewItem(item, type) {
                    if (!item || !type) return;

                    this.currentViewItem = item;
                    this.viewModalTitle = `View ${type.charAt(0).toUpperCase() + type.slice(1)}: ${item.initiativeName || item.opportunityName || item.personName || item.programName}`;

                    let schemaDefinition;
                    if (type === 'program') schemaDefinition = APP_SCHEMA.definitions.programConfiguration;
                    else if (type === 'person') schemaDefinition = APP_SCHEMA.definitions.person;
                    else if (type === 'opportunity') schemaDefinition = APP_SCHEMA.definitions.opportunity;
                    else if (type === 'initiative') schemaDefinition = APP_SCHEMA.definitions.initiative;

                    this.currentViewItemFields = Object.entries(schemaDefinition.properties || {}).map(([key, prop]) => ({
                         key: key,
                         title: prop.title || appUtils.formatFieldName(key),
                         description: prop.description || 'No description available.',
                         type: prop.type,
                         format: prop.format,
                         relationshipType: prop.relationshipType,
                         isSimpleStringArray: prop.type === 'array' && prop.items && prop.items.type === 'string' && ['programStages', 'programDefaultOpportunityStatuses', 'programDefaultInitiativeTypes', 'initiativeGoals', 'initiativeNextSteps', 'initiativeResources', 'initiativeRisks'].includes(key)
                    }));

                    this.findRelatedItems(item, type);

                    this.showViewModal = true;
                    this.$nextTick(() => { lucide.createIcons(); });
                },
                closeViewModal() {
                    this.showViewModal = false;
                    this.currentViewItem = null;
                    this.viewModalTitle = '';
                    this.currentViewItemFields = [];
                    this.relatedItems = [];
                },
                findRelatedItems(item, type) {
                    this.relatedItems = [];
                    if (!item || !type || !this.appData) return;

                    // Find items that reference the current item
                    if (type === 'person') {
                        // Find opportunities proposed by this person
                        (this.appData.opportunities || []).forEach(opp => {
                            if (opp.opportunityProposerId === item.personId) {
                                this.relatedItems.push({ id: opp.opportunityId, name: opp.opportunityName, type: 'opportunity', item: opp });
                            }
                        });
                        // Find initiatives managed by this person
                        (this.appData.initiatives || []).forEach(init => {
                            if (init.initiativeManagerId === item.personId) {
                                this.relatedItems.push({ id: init.initiativeId, name: init.initiativeName, type: 'initiative', item: init });
                            }
                        });
                    } else if (type === 'opportunity') {
                        // Find initiatives linked to this opportunity
                        (this.appData.initiatives || []).forEach(init => {
                            if (init.initiativeOpportunityId === item.opportunityId) {
                                this.relatedItems.push({ id: init.initiativeId, name: init.initiativeName, type: 'initiative', item: init });
                            }
                        });
                    } else if (type === 'initiative') {
                        // Find the manager of this initiative
                        if (item.initiativeManagerId) {
                             const manager = this.getPerson(item.initiativeManagerId);
                             if (manager) {
                                 this.relatedItems.push({ id: manager.personId, name: manager.personName, type: 'person', item: manager });
                             }
                        }
                        // Find the opportunity linked to this initiative
                        if (item.initiativeOpportunityId) {
                            const opportunity = this.getOpportunity(item.initiativeOpportunityId);
                            if (opportunity) {
                                this.relatedItems.push({ id: opportunity.opportunityId, name: opportunity.opportunityName, type: 'opportunity', item: opportunity });
                            }
                        }
                    }
                    // Program has no direct relationships to other items in this schema structure
                },
                async fetchDocumentation() {
                    try {
                        const response = await fetch('./docs.md');
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const markdown = await response.text();
                        this.parseDocumentation(markdown);
                    } catch (error) {
                        console.error("Error fetching documentation:", error);
                        this.showNotification('Error', 'Failed to load documentation.', 'error');
                    }
                },
                parseDocumentation(markdown) {
                    const lines = markdown.split('\n');
                    let currentEntity = null;
                    let currentField = null;
                    let descriptionLines = [];
                    this.documentation = {};

                    for (const line of lines) {
                        const entityMatch = line.match(/^##\s+(.+)\s+\(`(\w+)`\)/);
                        const fieldMatch = line.match(/^###\s+`(\w+)`/);

                        if (entityMatch) {
                            if (currentField && descriptionLines.length > 0) {
                                this.documentation[currentEntity][currentField] = descriptionLines.join('\n').trim();
                            }
                            currentEntity = entityMatch[2];
                            this.documentation[currentEntity] = {};
                            currentField = null;
                            descriptionLines = [];
                        } else if (fieldMatch) {
                             if (currentField && descriptionLines.length > 0) {
                                this.documentation[currentEntity][currentField] = descriptionLines.join('\n').trim();
                            }
                            currentField = fieldMatch[1];
                            descriptionLines = [];
                        } else if (currentField !== null) {
                            descriptionLines.push(line);
                        }
                    }

                    // Capture the last field's description
                    if (currentField && descriptionLines.length > 0) {
                         this.documentation[currentEntity][currentField] = descriptionLines.join('\n').trim();
                    }
                     console.log("Parsed Documentation:", this.documentation); // Log for debugging
                },
                showHelp(fieldKey, entityType) {
                    const entityKey = entityType === 'initiative' ? 'initiative' : entityType === 'opportunity' ? 'opportunity' : entityType === 'person' ? 'person' : 'program';
                    const markdownContent = this.documentation[entityKey] ? this.documentation[entityKey][fieldKey] : null;

                    console.log(`Attempting to show help for field: ${fieldKey}, entity: ${entityType}`);
                    console.log("Documentation object:", this.documentation);
                    console.log("Markdown content found:", markdownContent);

                    if (markdownContent) {
                        this.helpModalTitle = `Help: ${appUtils.formatFieldName(fieldKey)}`;
                        // Render Markdown and sanitize HTML
                        const renderedHtml = marked.parse(markdownContent);
                        this.renderedHelpContent = DOMPurify.sanitize(renderedHtml);
                        this.showHelpModal = true;
                         this.$nextTick(() => { lucide.createIcons(); });
                    } else {
                        this.showNotification('Info', 'Documentation not available for this field.', 'info');
                    }
                },
                closeHelpModal() {
                    this.showHelpModal = false;
                    this.helpModalTitle = '';
                    this.renderedHelpContent = '';
                },
                // Modal stacking logic
                openModal(type, item = null) {
                    if (type === 'editProgram') {
                        this.editProgram();
                    } else if (type === 'addPerson') {
                        this.addPerson();
                    } else if (type === 'editPerson') {
                        this.editPerson(item);
                    } else if (type === 'addOpportunity') {
                        this.addOpportunity();
                    } else if (type === 'editOpportunity') {
                        this.editOpportunity(item);
                    } else if (type === 'addInitiative') {
                        this.addInitiative();
                    } else if (type === 'editInitiative') {
                        this.editInitiative(item);
                    } else if (type === 'viewItem') {
                         this.viewItem(item.item, item.type); // Pass item and type
                    } else if (type === 'showHelp') {
                         this.showHelp(item.fieldKey, item.entityType); // Pass fieldKey and entityType
                    }
                     // Adjust modal positions
                    this.$nextTick(() => {
                        this.adjustModalPositions();
                    });
                },
                closeAnyModal() {
                    if (this.showHelpModal) {
                        this.closeHelpModal();
                    } else if (this.showViewModal) {
                        this.closeViewModal();
                    } else if (this.showModal) {
                        this.closeModal();
                    }
                     this.$nextTick(() => {
                        this.adjustModalPositions();
                    });
                },
                 adjustModalPositions() {
                    const modals = document.querySelectorAll('.fixed.inset-0.bg-black\\/30');
                    modals.forEach((modal, index) => {
                        const offset = index * 20; // 20px offset per modal
                        modal.style.zIndex = 50 + index;
                        const modalContent = modal.querySelector('.relative.mx-auto');
                        if (modalContent) {
                            modalContent.style.transform = `translate(-50%, -50%) translate(${offset}px, ${offset}px)`;
                            modalContent.style.top = '50%';
                            modalContent.style.left = '50%';
                        }
                    });
                }
            },
            // --- LIFECYCLE HOOKS ---
            mounted() {
                this.$nextTick(() => {
                    lucide.createIcons();
                });
                this.fetchDocumentation(); // Fetch documentation on mount
            },
            updated() {
                this.$nextTick(() => {
                    lucide.createIcons();
                });
            }
        }); // End of createApp options

        // Expose appUtils to the global context of the Vue app instance
        app.config.globalProperties.appUtils = appUtils;

        app.mount('#app'); // Mount the app

        // Original Lucide icon initialization - can be kept or removed if Vue's hooks are sufficient
        // document.addEventListener('DOMContentLoaded', function() {
        //     lucide.createIcons();
        // }); // This is commented out as Vue's mounted/updated hooks handle icons.
    </script>
    <!-- Modal HTML was already added in a previous step by a similar subtask, will verify its presence and structure -->
    <!-- Ensuring Lucide JS is loaded before the custom script -->
    <!-- The old DOMContentLoaded script will be removed. -->
</body>
</html>
